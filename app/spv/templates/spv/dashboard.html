{% extends "layouts/app.html" %} {% block content %}
<meta http-equiv="refresh" content="60" />

<style>
  html,
  body {
    height: 100%;
    overflow: hidden; /* Mengunci scroll utama body */
    background-color: #f8f9fa;
  }

  /* Mengunci tinggi wrapper utama agar pas di screen */
  .dashboard-wrapper {
    height: calc(100vh - 100px);
    display: flex;
    flex-direction: column;
    width: 100%;
    overflow-x: hidden; /* Mencegah pergeseran horizontal */
  }

  .card {
    border-radius: 15px;
    border: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    background: white;
  }

  .card-header {
    background-color: white !important;
    border-bottom: 1px solid #f1f1f1 !important;
    padding: 1rem 1.25rem !important;
  }

  .status-badge {
    padding: 5px 12px;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .bg-success-soft {
    background-color: #e8f5e9;
    color: #198754;
  }
  .bg-secondary-soft {
    background-color: #f8f9fa;
    color: #6c757d;
    border: 1px solid #dee2e6;
  }
  .alert-card {
    background-color: #fff5f5;
    border-left: 4px solid #dc3545;
    border-radius: 12px;
    transition: 0.2s;
  }

  .stats-label {
    font-size: 0.65rem;
    color: #adb5bd;
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  /* Pulse Animation untuk Live Monitoring */
  .pulse-dot {
    height: 8px;
    width: 8px;
    background-color: #198754;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
    box-shadow: 0 0 0 rgba(25, 135, 84, 0.4);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(25, 135, 84, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(25, 135, 84, 0); }
  }

  /* Scroll area independen untuk tabel dan alert */
  .scroll-area {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }
  
  .scroll-area::-webkit-scrollbar { width: 4px; }
  .scroll-area::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 10px; }

  /* Mencegah row luber horizontal */
  .row {
    margin-right: 0;
    margin-left: 0;
  }
</style>

<div class="container-fluid py-3 dashboard-wrapper">
  <div class="row align-items-center mb-3 flex-shrink-0">
    <div class="col-md-7">
      <h2 class="fw-bold text-dark mb-1">Supervisor Dashboard</h2>
      <p class="text-muted small mb-0">
        Branch: <span class="fw-bold text-primary">BCA Syariah - Jakarta</span> | 
        Status: <span class="badge bg-light text-success border"><span class="pulse-dot"></span>Live Monitoring</span>
      </p>
    </div>
    <div class="col-md-5 text-md-end">
      <span class="badge bg-light text-secondary border p-2 shadow-sm">
        <i class="bi bi-clock-fill me-1"></i> LAST UPDATE: {{ current_time if current_time else 'REAL-TIME' }}
      </span>
    </div>
  </div>

  <div class="row g-3 mb-3 flex-shrink-0">
    <div class="col-md-4">
      <div class="card p-3">
        <span class="stats-label">Sessions (Today)</span>
        <h3 class="fw-bold text-primary mb-0">{{ total_sessions }}</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <span class="stats-label">Active Workstations</span>
        <h3 class="fw-bold text-success mb-0">
          {{ active_ws }} <small class="h6 text-muted">/ {{ stations|length }}</small>
        </h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <span class="stats-label">Manual Overrides</span>
        <h3 class="fw-bold text-danger mb-0">{{ alerts|length }}</h3>
      </div>
    </div>
  </div>

  <div class="row g-3 flex-grow-1 overflow-hidden">
    <div class="col-lg-8 h-100 d-flex flex-column">
      <div class="card h-100 d-flex flex-column overflow-hidden">
        <div class="card-header d-flex justify-content-between align-items-center flex-shrink-0">
          <h6 class="fw-bold mb-0 text-dark">Station Monitoring</h6>
          <span class="badge bg-dark small">{{ stations|length }} Stations</span>
        </div>
        <div class="card-body p-0 scroll-area">
          <div class="table-responsive">
            <table class="table align-middle mb-0 table-hover">
              <thead class="bg-light sticky-top">
                <tr class="stats-label">
                  <th class="ps-4 py-3">Station</th>
                  <th>Service Activity</th>
                  <th>Status</th>
                  <th class="pe-4">Location</th>
                </tr>
              </thead>
              <tbody>
                {% for station, session, user in stations %}
                <tr>
                  <td class="ps-4">
                    <div class="fw-bold text-dark small">{{ station.workstation_id }}</div>
                    <small class="text-muted" style="font-size: 0.65rem">PC: {{ station.pc_id }}</small>
                  </td>
                  <td>
                    {% if session %}
                    <div class="d-flex flex-column">
                      <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-person-circle text-primary me-2" style="font-size: 0.8rem"></i>
                        <span class="fw-semibold small">{{ user.name if user else 'Staff' }}</span>
                      </div>
                      <div class="d-flex align-items-center">
                        <i class="bi bi-briefcase text-primary me-2" style="font-size: 0.7rem"></i>
                        <small class="text-primary fw-bold" style="font-size: 0.65rem">
                          {{ session.service_detected }}
                        </small>
                      </div>
                    </div>
                    {% else %}
                    <span class="text-muted small italic" style="font-size: 0.65rem">No Active Service</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if session %}
                    <span class="status-badge bg-success-soft">
                      <span class="pulse-dot"></span>IN-USE
                    </span>
                    {% else %}
                    <span class="status-badge bg-secondary-soft">AVAILABLE</span>
                    {% endif %}
                  </td>
                  <td class="pe-4 small text-muted" style="font-size: 0.65rem">{{ station.location }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4 h-100 d-flex flex-column">
      <div class="card h-100 d-flex flex-column overflow-hidden">
        <div class="card-header flex-shrink-0">
          <h6 class="fw-bold mb-0 text-danger">Bypass Alerts</h6>
        </div>
        <div class="card-body px-3 py-3 scroll-area">
          {% if alerts %} 
            {% for record, user in alerts %}
            <div class="alert-card p-3 mb-2 shadow-sm border">
              <div class="d-flex justify-content-between mb-1">
                <span class="fw-bold small text-dark">{{ user.name if user else 'Staff' }}</span>
                <small class="text-danger fw-bold" style="font-size: 0.6rem">{{ record.service_record_id }}</small>
              </div>
              <div class="small text-muted mb-2" style="font-size: 0.65rem">
                <i class="bi bi-megaphone me-1"></i> {{ record.service_detected }}
              </div>
              <div class="p-2 bg-white rounded border mb-2" style="font-size: 0.6rem; font-style: italic;">
                "{{ record.reason if record.reason else 'No reason provided' }}"
              </div>
              <div class="text-end">
                <small class="text-muted" style="font-size: 0.55rem">
                  <i class="bi bi-clock me-1"></i>{{ record.start_time.strftime('%H:%M:%S') if record.start_time else '-' }}
                </small>
              </div>
            </div>
            {% endfor %} 
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-shield-check text-light display-4"></i>
              <p class="text-muted small mt-2">No procedural overrides today.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}